<!--
ملاحظة مهمة قبل الاستخدام:
1) أنشئ مشروع Firebase (https://console.firebase.google.com) ومفعل:
   - Authentication: Email/Password و Google sign-in
   - Firestore (or Realtime DB) (نستخدم Firestore للرسائل + Realtime DB لإشارة WebRTC)
   - Storage لتحميل صور الحساب
2) انسخ إعدادات firebaseConfig وضعها في المكان المشار إليه أدناه.
3) رافع هذا الملف على GitHub Pages أو أي استضافة ثابتة. ستحتاج لسياسة CORS صحيحة على Firebase Storage (افتراضي يعمل).
4) هذا ملف HTML واحد يحوي واجهة تسجيل/دردشة + مكالمات صوت/فيديو عبر WebRTC.

محدوديات وملحوظات:
- تطبيق تعليمي وبدائي: لإنتاج تطبيق جاهز للإنتاج يجب تأمين قواعد Firestore/Storage، اختبار الأداء ورفع تصميم واجهات/UX.
- استخدام Realtime DB لقنوات الإشارة: كل مكالمة تستخدم "rooms/{roomId}" لعمل signaling عبر SimplePeer.
- تأكد أن إعدادات OAuth في Firebase تتضمن origin موقعك (مثلاً https://yourusername.github.io)
--><!doctype html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>موقع رسائل - نص صوت فيديو (Single HTML)</title>
  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* بسيط لتوسيط الفيديوهات */
    .video-box { width: 100%; height: 240px; background: #111827; display:flex; align-items:center; justify-content:center; }
    video { max-width:100%; max-height:100%; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
  <div class="max-w-6xl mx-auto p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- لوحة الحساب / تسجيل الدخول -->
    <aside class="col-span-1 bg-white p-4 rounded-lg shadow">
      <h2 class="text-2xl font-semibold mb-3">حسابك</h2>
      <div id="auth-area">
        <div id="not-signed" class="space-y-2">
          <input id="name" placeholder="الاسم الكامل" class="w-full p-2 border rounded" />
          <input id="username" placeholder="اسم المستخدم" class="w-full p-2 border rounded" />
          <input id="email" placeholder="البريد (جيميل)" class="w-full p-2 border rounded" />
          <input id="password" type="password" placeholder="كلمة السر" class="w-full p-2 border rounded" />
          <div class="flex gap-2">
            <button id="signup" class="flex-1 bg-blue-600 text-white p-2 rounded">سجل</button>
            <button id="signin" class="flex-1 bg-green-600 text-white p-2 rounded">دخول</button>
          </div>
          <button id="googleSign" class="w-full bg-white border p-2 rounded flex items-center justify-center gap-2">سجل بـ Google</button>
        </div>
        <div id="signed" class="hidden">
          <div class="flex items-center gap-3">
            <img id="avatar" src="https://via.placeholder.com/80" class="w-20 h-20 rounded-full object-cover" />
            <div>
              <div id="displayName" class="font-semibold"></div>
              <div id="displayUsername" class="text-sm text-gray-500"></div>
            </div>
          </div>
          <div class="mt-3">
            <input id="avatarFile" type="file" accept="image/*" />
            <button id="uploadAvatar" class="mt-2 w-full bg-indigo-600 text-white p-2 rounded">تحميل الصورة</button>
          </div>
          <div class="mt-4">
            <button id="signout" class="w-full bg-red-500 text-white p-2 rounded">تسجيل الخروج</button>
          </div>
        </div>
      </div>
      <hr class="my-4" />
      <div>
        <h3 class="font-semibold mb-2">قائمة المستخدمين</h3>
        <div id="usersList" class="space-y-2 max-h-48 overflow-auto"></div>
      </div>
    </aside><!-- غرفة الدردشة -->
<main class="col-span-2 bg-white p-4 rounded-lg shadow">
  <div class="flex gap-4">
    <div class="flex-1">
      <h2 class="text-xl font-semibold">الدردشة</h2>
      <div id="messages" class="mt-3 p-3 border rounded h-64 overflow-auto bg-gray-50"></div>
      <div class="flex gap-2 mt-3">
        <input id="messageInput" placeholder="اكتب رسالة..." class="flex-1 p-2 border rounded" />
        <button id="sendMsg" class="bg-blue-600 text-white p-2 rounded">إرسال</button>
      </div>
    </div>
    <div style="width:320px">
      <h3 class="font-semibold">مكالمة سريعة</h3>
      <div class="video-box mt-2" id="localWrap">
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
      <div class="video-box mt-2" id="remoteWrap">
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
      <div class="flex gap-2 mt-3">
        <button id="startCall" class="flex-1 bg-green-600 text-white p-2 rounded">اتصال</button>
        <button id="answerCall" class="flex-1 bg-indigo-600 text-white p-2 rounded">قبول</button>
        <button id="endCall" class="flex-1 bg-red-600 text-white p-2 rounded">انهاء</button>
      </div>
      <div class="mt-2 text-sm text-gray-500">ملاحظة: يُستخدم WebRTC (signaling عبر Firebase Realtime DB).</div>
    </div>
  </div>
</main>

  </div>  <!-- مكتبات: Firebase و SimplePeer -->  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>  <script>
  // ====== ضع إعدادات Firebase هنا (انسخها من لوحة Firebase) ======
  const firebaseConfig = {
    apiKey: "REPLACE_WITH_YOUR_API_KEY",
    authDomain: "REPLACE_WITH_YOUR_AUTH_DOMAIN",
    projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
    storageBucket: "REPLACE_WITH_YOUR_STORAGE_BUCKET",
    messagingSenderId: "REPLACE_WITH_MESSAGING_SENDER_ID",
    appId: "REPLACE_WITH_YOUR_APP_ID",
    databaseURL: "REPLACE_WITH_YOUR_DATABASE_URL"
  };
  // ==============================================================

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  const rtdb = firebase.database();

  // عناصر DOM
  const notSigned = document.getElementById('not-signed');
  const signed = document.getElementById('signed');
  const displayName = document.getElementById('displayName');
  const displayUsername = document.getElementById('displayUsername');
  const avatar = document.getElementById('avatar');
  const usersList = document.getElementById('usersList');
  const messagesDiv = document.getElementById('messages');

  // تسجيل
  document.getElementById('signup').onclick = async ()=>{
    const name = document.getElementById('name').value.trim();
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if(!email||!password||!name||!username){ alert('اكمل الحقول'); return; }
    try{
      const cred = await auth.createUserWithEmailAndPassword(email,password);
      await cred.user.updateProfile({displayName: name});
      // سجل بيانات المستخدم في Firestore
      await db.collection('users').doc(cred.user.uid).set({
        name, username, email, uid: cred.user.uid, avatarUrl: null, online: true
      });
    }catch(e){ alert(e.message); }
  }

  // دخول
  document.getElementById('signin').onclick = async ()=>{
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    try{ await auth.signInWithEmailAndPassword(email,password); }catch(e){ alert(e.message); }
  }

  // Google Sign-in
  document.getElementById('googleSign').onclick = async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    try{
      const res = await auth.signInWithPopup(provider);
      const u = res.user;
      // upsert in users collection
      await db.collection('users').doc(u.uid).set({
        name: u.displayName, username: u.email.split('@')[0], email: u.email, uid: u.uid, avatarUrl: u.photoURL||null, online: true
      },{merge:true});
    }catch(e){ alert(e.message); }
  }

  // sign out
  document.getElementById('signout').onclick = ()=>auth.signOut();

  // عند تغيّر حالة المصادقة
  auth.onAuthStateChanged(async user=>{
    if(user){
      notSigned.classList.add('hidden'); signed.classList.remove('hidden');
      displayName.textContent = user.displayName || user.email;
      // جلب بيانات إضافية من Firestore
      const doc = await db.collection('users').doc(user.uid).get();
      const data = doc.exists? doc.data() : null;
      displayUsername.textContent = data?.username ? '@'+data.username : '';
      avatar.src = data?.avatarUrl || user.photoURL || 'https://via.placeholder.com/80';
      // ضع المستخدم أونلاين
      await db.collection('users').doc(user.uid).set({online:true},{merge:true});
      subscribeUsers();
      subscribeMessages();
    }else{
      notSigned.classList.remove('hidden'); signed.classList.add('hidden');
      displayName.textContent=''; displayUsername.textContent=''; avatar.src='https://via.placeholder.com/80';
    }
  });

  // رفع الصورة
  document.getElementById('uploadAvatar').onclick = async ()=>{
    const file = document.getElementById('avatarFile').files[0];
    if(!file) return alert('اختر صورة');
    const user = auth.currentUser; if(!user) return alert('سجل الدخول');
    const ref = storage.ref().child(`avatars/${user.uid}/${file.name}`);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    await db.collection('users').doc(user.uid).set({avatarUrl: url},{merge:true});
    avatar.src = url;
  }

  // جلب قائمة المستخدمين
  let usersUnsub = null;
  function subscribeUsers(){
    if(usersUnsub) usersUnsub();
    usersUnsub = db.collection('users').onSnapshot(snap=>{
      usersList.innerHTML = '';
      snap.forEach(doc=>{
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'p-2 border rounded flex items-center justify-between';
        el.innerHTML = `<div class=\"flex items-center gap-2\"><img src=\"${d.avatarUrl||'https://via.placeholder.com/40'}\" class=\"w-10 h-10 rounded-full object-cover\"/><div><div class=\"font-semibold\">${d.name}</div><div class=\"text-sm text-gray-500\">@${d.username||''}</div></div></div><div><button class=\"callBtn bg-blue-600 text-white p-1 rounded\" data-uid=\"${d.uid}\">اتصال</button></div>`;
        usersList.appendChild(el);
      });
      // ربط أزرار الاتصال
      document.querySelectorAll('.callBtn').forEach(btn=>{
        btn.onclick = ()=>{ startCallTo(btn.dataset.uid); }
      });
    });
  }

  // الدردشة: حفظ ونشر الرسائل (بسيط - جميع الرسائل عامة في هذه النسخة)
  document.getElementById('sendMsg').onclick = async ()=>{
    const txt = document.getElementById('messageInput').value.trim();
    if(!txt) return;
    const user = auth.currentUser; if(!user) return alert('سجل الدخول');
    await db.collection('messages').add({
      text: txt, uid: user.uid, name: user.displayName || user.email, ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('messageInput').value='';
  }

  function subscribeMessages(){
    db.collection('messages').orderBy('ts','asc').limitToLast(200).onSnapshot(snap=>{
      messagesDiv.innerHTML='';
      snap.forEach(doc=>{
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'p-2 mb-2 bg-white border rounded';
        el.innerHTML = `<div class=\"font-semibold\">${d.name||'مستخدم'}</div><div>${d.text}</div>`;
        messagesDiv.appendChild(el);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  // ======= WebRTC (SimplePeer) باستخدام Realtime DB كقناة إشارة =======
  let localStream=null, peer=null, currentCallRef=null;
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  async function ensureLocalStream(){
    if(localStream) return localStream;
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    return localStream;
  }

  // بدء المكالمة: ننشئ غرفة جديدة في RTDB وننشر offer
  async function startCallTo(targetUid){
    const me = auth.currentUser; if(!me) return alert('سجل الدخول');
    await ensureLocalStream();
    const roomId = db.collection('calls').doc().id; // random id
    const callRef = rtdb.ref('rooms/' + roomId);
    currentCallRef = callRef;

    peer = new SimplePeer({initiator:true, trickle:false, stream: localStream});
    peer.on('signal', async data=>{
      // write offer to RTDB
      await callRef.set({from: me.uid, to: targetUid, offer: JSON.stringify(data)});
    });
    peer.on('stream', stream=>{ remoteVideo.srcObject = stream; });
    // استمع لردود في الغرفة (answer)
    callRef.on('value', snapshot=>{
      const v = snapshot.val();
      if(v && v.answer){
        const answer = JSON.parse(v.answer);
        peer.signal(answer);
      }
    });

    alert('تم إنشاء غرفة الاتصال - شارك الـ roomId مع المستقبل أو دع الخادم يربط. RoomId: ' + roomId);
    // ملاحظة: هنا نقدم roomId فقط كمثال. في نسخة أفضل نحفظ roomId في Firestore للمستخدم الهدف.
  }

  // لرد على مكالمة: المستخدم المستهدف يجب أن يحصل على roomId من القناة (أو من قائمة مكالمات)
  // في هذه المثال البسيط سنبحث عن غرفة موجهة إلينا في RTDB حيث to==myUid و لا يوجد answer
  document.getElementById('answerCall').onclick = async ()=>{
    const me = auth.currentUser; if(!me) return alert('سجل الدخول');
    // ابحث عن غرفة موجهة لي
    const roomsSnap = await rtdb.ref('rooms').orderByChild('to').equalTo(me.uid).once('value');
    const rooms = roomsSnap.val();
    if(!rooms){ return alert('لا توجد طلبات اتصال واردة'); }
    const roomId = Object.keys(rooms)[0];
    const call = rooms[roomId];
    if(!call.offer) return alert('لا توجد عرض (offer)');
    await ensureLocalStream();
    currentCallRef = rtdb.ref('rooms/' + roomId);
    peer = new SimplePeer({initiator:false, trickle:false, stream: localStream});
    peer.on('signal', async data=>{
      // أرسل answer
      await currentCallRef.update({answer: JSON.stringify(data)});
    });
    peer.on('stream', stream=>{ remoteVideo.srcObject = stream; });

    // signal the offer
    peer.signal(JSON.parse(call.offer));
    alert('تم قبول المكالمة');
  }

  document.getElementById('endCall').onclick = async ()=>{
    if(peer){ peer.destroy(); peer = null; }
    if(currentCallRef){ currentCallRef.remove(); currentCallRef = null; }
    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; localVideo.srcObject=null; remoteVideo.srcObject=null; }
  }

  // بدء اتصال من الزر بجانب المستخدم (سيقوم بإنشاء غرفة وتحويل الـ to)
  async function startCallTo(uid){
    const me = auth.currentUser; if(!me) return alert('سجل الدخول');
    await ensureLocalStream();
    const roomRef = rtdb.ref('rooms').push();
    const roomId = roomRef.key;
    peer = new SimplePeer({initiator:true, trickle:false, stream: localStream});
    peer.on('signal', async data=>{
      await roomRef.set({from: me.uid, to: uid, offer: JSON.stringify(data)});
    });
    peer.on('stream', stream=>{ remoteVideo.srcObject = stream; });
    // انتظر answer
    roomRef.on('value', snap=>{
      const v = snap.val();
      if(v && v.answer){ peer.signal(JSON.parse(v.answer)); }
    });
    currentCallRef = roomRef;
    alert('جاري محاولة الاتصال...');
  }

  // زر بدء عام
  document.getElementById('startCall').onclick = ()=>{
    // نفتح دعوة عامة (بدون مستهدف) — هنا مجرد مثال لإنشاء room بدون to
    alert('لاختيار من تريد الاتصال به: اضغط زر الاتصال بجانب المستخدم في قائمة المستخدمين.');
  }

  // تنظيف عند ترك الصفحة
  window.addEventListener('beforeunload', ()=>{
    const u = auth.currentUser;
    if(u){ db.collection('users').doc(u.uid).set({online:false},{merge:true}); }
  });

  </script></body>
</html>
